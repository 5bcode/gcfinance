# CLAUDE.md — SavinCGs (gcfinance)

This file is the primary reference for AI assistants working on this repository.
Read it fully before making any changes.

---

## Project Overview

**SavinCGs** is a personal savings planning PWA for a couple (Gary & Catherine).
It allows them to track bank accounts, set savings goals with sub-goals, allocate money from accounts to sub-goals, and monitor monthly savings progress.

- **App name**: SavinCGs
- **Currency**: GBP (£) — all monetary values are integers (pence are dropped)
- **Users**: Gary, Catherine, Joint (these three owner values are fixed constants)
- **Deployment**: Vercel (no build step — the repo root is the output directory)
- **Cloud sync**: Firebase Firestore (`gcfinance-80a66` project)

---

## Tech Stack

| Layer | Technology |
|---|---|
| HTML | Single file `index.html` (598 lines) |
| JavaScript | Vanilla ES2022, global scope, no modules (`app.js`, 2103 lines) |
| CSS | Vanilla CSS (`styles.css` 2858 lines, `toast.css`) |
| Fonts | Google Fonts — Inter, Space Grotesk (loaded via CDN) |
| Cloud sync | Firebase Firestore v10 (loaded via ESM CDN) |
| Confetti | `canvas-confetti@1.6.0` (CDN) |
| Chart | HTML Canvas (custom, no charting library) |
| PWA | Web App Manifest + iOS meta tags |
| Deployment | Vercel (`vercel.json` — no build command) |

There is **no package.json**, **no bundler**, **no TypeScript**, and **no npm dependencies**. All external libraries are loaded from CDNs at runtime.

---

## File Structure

```
gcfinance/
├── index.html                   # All HTML, inline Firebase ESM script, CDN script tags
├── app.js                       # All application logic (global scope)
├── styles.css                   # All styles
├── toast.css                    # Toast notification animations
├── favicon.svg                  # SVG favicon / PWA icon
├── manifest.json                # PWA manifest (app name, icons, display mode)
├── vercel.json                  # Vercel config (no build, output dir = ".")
├── CLAUDE.md                    # This file
├── TEST_COVERAGE_ANALYSIS.md    # Detailed test coverage analysis (0% current coverage)
├── implementation_plan_polish.md # UI polish notes and pending tasks
└── output/
    └── playwright/              # Manual screenshots (no test scripts exist yet)
        ├── desktop.png
        ├── interactive-desktop.png
        ├── interactive-desktop-edits.png
        ├── interactive-iphone15.png
        ├── iphone15.png
        └── reset-state.png
```

---

## Data Model

All persistent state lives in a single global object. It is stored in `localStorage` under the key `"gcfinance-v1"` and synced to Firestore.

```js
state = {
  accounts: [
    {
      id: string,       // "acct-<random>" — generated by makeId("acct")
      name: string,     // User-defined nickname, e.g. "Rainy Day"
      type: string,     // One of ACCOUNT_TYPES
      provider: string, // Bank name, e.g. "Monzo"
      owner: string,    // One of OWNERS: "Gary" | "Catherine" | "Joint"
      balance: number,  // Integer GBP, always >= 0
    }
  ],
  goals: [
    {
      id: string,       // "goal-<random>"
      name: string,     // e.g. "House Purchase"
      subGoals: [
        {
          id: string,   // "sg-<random>"
          name: string, // e.g. "Deposit"
          target: number, // Integer GBP, always >= 0
        }
      ]
    }
  ],
  allocations: [
    {
      id: string,        // "alloc-<random>"
      accountId: string, // References accounts[].id
      subGoalId: string, // References goals[].subGoals[].id
      amount: number,    // Integer GBP, always > 0
    }
  ],
  monthlyProgress: [     // Always exactly 12 entries, one per month
    {
      month: string,     // "January" ... "December"
      plannedGary: number,
      actualGary: number,
      plannedCat: number,
      actualCat: number,
      notes: string,
    }
  ],
  progressYear: number,  // e.g. 2026
}
```

### Key Constants (app.js top of file)

```js
const OWNERS = ["Gary", "Catherine", "Joint"];
const ACCOUNT_TYPES = ["Current Account", "Savings", "ISA", "Credit Card", "Other"];
const MONTHS = ["January", ..., "December"];
const STORAGE_KEY = "gcfinance-v1";
const SIMPLE_MODE_KEY = "gcfinance-simple-mode";
```

These constants are load-bearing — the UI and sort orders depend on their exact values and ordering. Do not reorder or rename them.

---

## Application Architecture

### State Lifecycle

```
loadState()          ← called once on boot; reads localStorage or returns DEFAULT_DATA
    ↓
state = { ... }      ← single global mutable object
    ↓
renderApp()          ← called after every mutation
  ├── sanitizeState()   ← normalize/fix/prune state in-place
  ├── deriveState()     ← compute derived values (does NOT mutate state)
  ├── render*()         ← update DOM sections using derived values
  └── saveState()       ← write to localStorage, optionally push to Firestore
```

### Render Architecture

`renderApp()` (line 1332) is the single top-level render function. It is **always called in full** — there is no partial/component-level re-rendering. Each sub-render function rebuilds the innerHTML of its target element.

Sub-render functions:
| Function | Updates |
|---|---|
| `renderSummary(derived)` | Summary cards (total funds, ready-to-assign, etc.) |
| `renderAccounts(derived)` | Accounts table, filter pills |
| `renderSimpleAccounts(derived)` | Simple mode accounts grid |
| `renderGoals(derived)` | Goals board (goal cards with sub-goal tables) |
| `renderSimpleGoals(derived)` | Simple mode goals overview |
| `renderAllocationForm(derived)` | Dropdowns in the Quick Assign form |
| `renderAllocations(derived)` | Allocation ledger table |
| `renderProgress()` | Progress panel stats, motivational banner, triggers chart |
| `renderProgressChart()` | Canvas chart (dual-axis bars + cumulative lines) |
| `updateSimpleMode()` | Toggles `simple-mode-hidden` / `simple-mode-only` visibility |

### Event Handling

All events are wired **once** in `wireEvents()` (line 1458), called from `bootstrap()`. Event delegation is used heavily — listeners are attached to parent containers (e.g. `accountsTbody`, `goalBoard`) and events are matched by `data-action` attributes or element types.

**Pattern for mutations**:
1. Event fires on a delegated parent
2. Find the nearest ancestor with the relevant `data-*` attribute to get the ID
3. Mutate `state` directly
4. Call `renderApp()` — this sanitizes, re-derives, re-renders, and saves

### Bootstrap Sequence

```
bootstrap()                       ← called at end of app.js (line 2103)
  ├── document.body.classList.add("entry-anim")  // page-load animation
  ├── renderApp()                  // initial render
  ├── wireEvents()                 // attach all listeners
  └── initCloudSync()              // connect to Firebase (if available)
        └── window.cloudSync.startCloudSync(callback)
```

---

## Cloud Sync (Firebase)

Firebase is initialized in an inline `<script type="module">` at the bottom of `index.html`. It exposes a `window.cloudSync` API that `app.js` consumes.

```js
window.cloudSync = {
  syncToCloud(data),       // writes state to Firestore as JSON string
  startCloudSync(onData),  // subscribes to Firestore; calls onData on each change
  stopCloudSync(),         // unsubscribes
  isEnabled(),             // returns boolean
}
```

**Firestore document**: `users/shared` — a single shared document for both users. State is stored as `{ payload: JSON.stringify(state) }`.

**Sync loop prevention**: A module-level `_skipCloudSync` boolean flag is set to `true` when an incoming cloud update is being applied, preventing `saveState()` from echoing it back to Firestore.

**Firebase project details** (in `index.html`):
- Project ID: `gcfinance-80a66`
- Auth domain: `gcfinance-80a66.firebaseapp.com`

---

## Key Functions Reference

### Financial Logic

| Function | Location | Description |
|---|---|---|
| `deriveState()` | line 317 | Computes all derived values from raw state. Returns `{ accountsDerived, goalsDerived, subGoalsDerived, totalFunds, totalAssigned, readyToAssign, underFunded, overallProgress, subGoalById }`. Does **not** mutate `state`. |
| `assignFunds(accountId, subGoalId, amount)` | line 1365 | Validates and applies a manual fund allocation. Shows toast on error. Caps to `account.available` and `subGoal.remaining`. Calls `renderApp()`. |
| `autoAssignReadyCash()` | line 1408 | Automatically distributes all available funds across unfunded sub-goals in order. Calls `renderApp()`. |
| `addOrUpdateAllocation(accountId, subGoalId, amount)` | line 1349 | Merges into an existing `(accountId, subGoalId)` allocation or pushes a new one. Does **not** call `renderApp()`. |

### State Management

| Function | Location | Description |
|---|---|---|
| `loadState()` | line 62 | Reads from localStorage, validates structure, falls back to `DEFAULT_DATA`. |
| `saveState()` | line 86 | Writes to localStorage and triggers cloud sync (unless `_skipCloudSync` is set). |
| `sanitizeState()` | line 250 | Normalizes state in-place: generates missing IDs, clamps negative balances to 0, removes orphaned allocations, migrates legacy monthly-progress field names. |

### Utilities

| Function | Description |
|---|---|
| `makeId(prefix)` | Returns a random string like `"acct-x7k3p2m"`. |
| `normalizeAmount(value)` | Coerces any value to a non-negative integer. Always use this for monetary inputs. |
| `escapeHtml(value)` | Escapes `&`, `<`, `>`, `"`, `'`. Must be used for **all** user-supplied content injected via `innerHTML`. |
| `flattenSubGoals(goals)` | Returns a flat list of all sub-goals with `goalId`, `goalName`, `goalIndex`, `subIndex` attached. |
| `inferTypeFromName(name)` | Guesses account type from name keywords. Used during `sanitizeState()`. |
| `showToast(title, message, type)` | Displays a toast. `type`: `"success"` \| `"info"` \| `"error"`. |
| `animateValue(id, start, end, duration)` | Smoothly animates a DOM element's numeric content using `requestAnimationFrame`. |
| `triggerConfetti()` | Fires the `canvas-confetti` effect when a goal is fully funded. |
| `dateLabel(date?)` | Returns a formatted UK date string, e.g. `"20 Feb 2026"`. |
| `GBP.format(value)` | `Intl.NumberFormat` for GBP, e.g. `"£1,500"`. No pence. |

---

## UI Patterns

### Simple Mode

The app has two display modes toggled by a switch in the nav bar:
- **Normal mode** — full detail: accounts table, allocation ledger, goals board
- **Simple mode** — summary only: owner totals, goal progress cards

CSS classes `simple-mode-hidden` and `simple-mode-only` control visibility. `updateSimpleMode()` adds/removes `hidden` attributes on these elements and toggles `simple-mode` on `document.body`.

Simple mode preference is persisted in `localStorage` under `SIMPLE_MODE_KEY`.

### Tab Navigation

Two tabs:
1. **Dashboard** (`data-tab="dashboard"`) — main workspace
2. **Progress** (`data-tab="progress"`) — monthly savings tracker and chart

Tabs are rendered as `<button class="tab-btn">` elements. Active state is set via the `active` CSS class. The canvas chart is re-rendered after switching to the Progress tab.

### Wizards (Modal Dialogs)

Two `<dialog>` element wizards:
- **Add Account** (`#addAccountWizard`) — 5 steps: type → name → owner → provider → balance
- **Add Goal** (`#addGoalWizard`) — 3 steps: goal name → first sub-goal name → first sub-goal target

Wizards use a step-by-step layout with `hidden` attributes on inactive steps. Progress is shown via a `<div class="wizard-progress-fill">` bar.

### Owner Colour Tokens

```
Gary      → CSS class suffix: "gary"
Catherine → CSS class suffix: "catherine"
Joint     → CSS class suffix: "joint"
```

Used on filter pills (`filter-pill--gary`) and owner indicators in the accounts table.

### Account Table Grouping

Accounts are grouped first by **type** (sorted by `ACCOUNT_TYPES` order), then sub-grouped by **provider** within each type. Provider sub-headers are only shown when a type group has more than one distinct provider.

---

## Coding Conventions

### General Rules

1. **No frameworks, no bundler, no TypeScript.** Keep all code in vanilla JS/HTML/CSS.
2. **No `npm install` or `package.json`** unless explicitly adding a testing framework (see TEST_COVERAGE_ANALYSIS.md for the recommended approach).
3. **All JS is global scope.** Functions and variables declared at the top level of `app.js` are globals accessible from event handlers and inline `<script>` blocks.
4. **One render cycle per mutation.** Always end a state mutation by calling `renderApp()`. Do not call individual `render*()` functions unless you have a specific reason (e.g. chart-only re-render on resize).

### Money / Amounts

- All amounts stored as **integers** (no decimals).
- Always pass monetary values through `normalizeAmount()` before storing: `normalizeAmount(value)` rounds to nearest integer and clamps to `>= 0`.
- Display amounts using `GBP.format(value)`.

### Security: XSS Prevention

- **Never** inject user-provided strings into `innerHTML` without wrapping them in `escapeHtml()`.
- This includes: account names, goal names, sub-goal names, provider names, owner names, notes.
- The `GBP.format()` output is safe (always numeric).

### IDs

- All IDs are generated at creation time with `makeId(prefix)` — e.g. `makeId("acct")` → `"acct-x7k3p2m"`.
- IDs are stored on state objects and used as `data-account-id`, `data-goal-id`, `data-subgoal-id`, `data-allocation-id` HTML attributes for event delegation.
- Never hard-code IDs.

### Event Delegation Pattern

```js
// ✅ Correct — delegate from stable container
parentElement.addEventListener("click", (event) => {
  const btn = event.target.closest("button[data-action='some-action']");
  if (!btn) return;
  const row = btn.closest("tr[data-account-id]");
  const accountId = row?.getAttribute("data-account-id");
  // ... mutate state ...
  renderApp();
});

// ❌ Avoid — attaching listeners to dynamically rendered elements
document.querySelectorAll(".row-remove").forEach(btn => {
  btn.addEventListener("click", ...); // These elements get destroyed on each render
});
```

### HTML Generation

Use template literals in render functions. Always escape user content:

```js
// ✅ Correct
`<td>${escapeHtml(account.name)}</td>`

// ❌ Incorrect — XSS risk
`<td>${account.name}</td>`
```

### CSS Class Naming

- Block-level sections: `.block`
- Summary cards: `.summary-card`
- Goal cards: `.goal-card`
- Table wrappers: `.table-wrap`
- Navigation: `.top-nav`, `.tab-bar`, `.tab-btn`
- Wizards: `.wizard-dialog`, `.wizard-step`, `.wizard-choice`
- Owner pills: `.owner-pill`, `.owner-pill--gary`, `.owner-pill--catherine`, `.owner-pill--joint`
- Filter pills: `.filter-pill`, `.filter-pill--gary`, etc.
- Buttons: `.btn`, `.btn-primary`, `.btn-secondary`, `.btn-ghost`, `.btn-danger`, `.row-remove`, `.action-ghost`
- Number alignment: `.number` class on `<td>` / `<th>` right-aligns and uses tabular figures
- Dark value: `.negative` class turns monetary values red

---

## Progress Chart

The progress chart (line ~800–1100 in `app.js`) is rendered on an HTML `<canvas>` element using the 2D Context API. It is a dual-axis chart:

- **Left axis**: Monthly savings amounts (Gary + Catherine planned/actual combined)
  - Planned: dashed purple outline bars
  - Actual: solid cyan/teal filled bars
- **Right axis (cumulative)**: Cumulative totals over the year
  - Planned cumulative: dashed purple Catmull-Rom spline line
  - Actual cumulative: solid cyan Catmull-Rom spline line with glow

The chart handles:
- HiDPI/retina displays via `devicePixelRatio` scaling
- Hover tooltips with a vertical highlight bar
- Responsive resize (via debounced `resize` listener)
- Current month highlighting
- Null values for future months (cumulative actual line stops at current month)

`renderProgressChart()` reads directly from `state.monthlyProgress`. It is called from `renderProgress()` and also re-triggered on window resize and tab switch.

---

## Testing

**Current state: 0% test coverage.** No test runner or test files exist.

See `TEST_COVERAGE_ANALYSIS.md` for a full analysis including:
- Priority matrix (P0–P3)
- Specific missing test cases for each critical function
- Recommended infrastructure setup (Vitest + jsdom for unit tests, Playwright for E2E)

The main obstacles to unit testing:
1. Functions are not exported (global scope only)
2. Core functions read/write the global `state` object directly

The recommended remediation path is to extract pure business-logic functions into a `lib.js` ES module (see TEST_COVERAGE_ANALYSIS.md §"Recommended First Steps").

**The `output/playwright/` directory contains screenshots only** — no actual Playwright test scripts exist.

---

## Development Workflow

### Running Locally

There is no dev server or build step. Open `index.html` directly in a browser, or serve the project root with any static file server:

```bash
# Using Python
python3 -m http.server 8080

# Using Node (if available)
npx serve .

# Or just open index.html directly in a browser
```

Cloud sync requires an internet connection (Firebase). Offline/local use works fine with localStorage only — the `syncBadge` in the nav will show "Local".

### Making Changes

1. Edit `app.js`, `styles.css`, or `index.html` directly.
2. Reload the browser to see changes.
3. There is no hot reload, watch mode, or compilation step.

### Git Workflow

- `master` — production branch; deploys to Vercel automatically
- Feature work happens on `claude/...` branches

### Deployment

Pushing to `master` triggers an automatic Vercel deployment. The `vercel.json` config:
```json
{
  "buildCommand": "echo 'No build needed'",
  "outputDirectory": ".",
  "framework": null
}
```

---

## Known Issues / Pending Work

From `implementation_plan_polish.md`:
- [ ] Table row staggered fade-in animations
- [ ] Button active/pressed states
- [ ] Enhanced input focus transitions
- [ ] Empty state illustrations/icons
- [ ] Verify toast slide animations

From `TEST_COVERAGE_ANALYSIS.md`:
- [ ] Set up Vitest for unit testing
- [ ] Extract pure functions into `lib.js`
- [ ] Write unit tests for P0 financial logic
- [ ] Write unit tests for P1 data integrity
- [ ] Write unit tests for P2 utilities
- [ ] Set up Playwright for E2E testing

---

## What Not to Change Without Careful Review

| Item | Reason |
|---|---|
| `OWNERS` constant order | Affects sort order, filter pills, and CSS class names |
| `ACCOUNT_TYPES` constant order | Determines account table grouping sort order |
| `STORAGE_KEY = "gcfinance-v1"` | Changing this would orphan existing user data |
| `escapeHtml()` calls | Removing them creates XSS vulnerabilities |
| `normalizeAmount()` calls | Removing them can introduce negative balances or floats |
| Firebase `users/shared` document path | Both users share this single document |
| `_skipCloudSync` guard | Removing it causes an infinite sync loop |
| `data-*` attribute names on HTML elements | Event delegation depends on these exact attribute names |
